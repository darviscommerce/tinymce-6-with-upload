/**
 * plugin.js
 *
 * Copyright, Alberto Peripolli
 * Released under Creative Commons Attribution-NonCommercial 3.0 Unported License.
 *
 * Contributing: https://github.com/trippo/ResponsiveFilemanager
 */

 tinymce.PluginManager.add('darvisfilemanager', function(editor) {
	console.log(editor.options);
	console.log(editor.options.get('custom_option')	);

	function darvisfilemanager_onMessage(event){
		console.log(event.data.sender);
		console.log(event.data.html);
		// if(editor.settings.external_filemanager_path.toLowerCase().indexOf(event.origin.toLowerCase()) === 0){
			if(event.data.sender === 'darvisfilemanager'){
	
				tinymce.activeEditor.insertContent(event.data.html);
				tinymce.activeEditor.windowManager.close();

				// Remove event listener for a message from ResponsiveFilemanager
				if(window.removeEventListener){
					window.removeEventListener('message', darvisfilemanager_onMessage, false);
				} else {
					window.detachEvent('onmessage', darvisfilemanager_onMessage);
				}
			}
		// }
	}
    
	function openmanager() {

		var width = window.innerWidth-20;
		var height = window.innerHeight-40;
		if(width > 1800) width=1800;
		if(height > 1200) height=1200;
		if(width>600){
			var width_reduce = (width - 20) % 138;
			width = width - width_reduce + 10;
		}

		editor.focus(true);


			if(window.addEventListener){
				window.addEventListener('message', darvisfilemanager_onMessage, false);
			} else {
				window.attachEvent('onmessage', darvisfilemanager_onMessage);
			}
	

    tinymce.activeEditor.windowManager.openUrl({
      type: 'custom', // component type
      title: 'Filemanager', // component type
      url: '/src/tinymanager/dialog.php?type=',
    }
    )

}



	/* Add a button that opens a window */
	editor.ui.registry.addButton('darvisfilemanager', {
		text: 'My button',
		onAction: function () {
		 openmanager();
		}
	 });
	 /* Adds a menu item, which can then be included in any menu via the menu/menubar configuration */
	 editor.ui.registry.addMenuItem('darvisfilemanager', {
		text: 'Example plugin',
		onAction: function () {
		 openmanager();
		}
	 });
});
